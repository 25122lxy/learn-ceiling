# MySQL



## 索引

### <font color=00dd00>1.索引是什么？（无过滤不索引）</font>

- 数据库索引，是数据库管理系统中一个排序的数据结构，以协助快速查询、更新数据库表中的数据
- 是一个文件，占据物理空间

### <font color=00dd00>2.索引有哪些优缺点？</font>

- 优点
  - **加快了数据的检索速度**
  - 使用索引，可以在查询过程中，使用隐藏优化器，提高系统性能
- 缺点
  - 时间方面：创建索引和维护索引（添加、删除、修改）要耗费时间
  - 空间方面：占据物理内存

### <font color=00dd00>3.MySQL有哪几种索引类型？</font>

- 存储结构：BTree、Hash、full-index、R-Tree
- 应用层面：
  - 普通索引：一个索引只能包含单个列，一个表可以有多个单列索引
  - 唯一索引：索引列的值必须唯一，但允许有空值
  - 复合索引：多列值组成一个索引，用于组合搜索，效率大于搜索合并
  - 聚簇索引：在同一个结构中保存了B-Tree索引(技术上来说是B+Tree)和数据行。
  - 非聚簇索引

### <font color=00dd00>4.说一说索引的底层实现?</font>

- B树
  - 节点排序
  - 一个节点可以存放多个元素，多个元素也排序了
- B+树
  - 拥有B树的特点
  - 叶子节点之间有指针
  - 非叶子节点上的元素在叶子节点上都冗余了，也就是叶子节点中存储了所有的元素，并且排好顺序
- Hash
  - 将所有的哈希码存储在索引中
  - 只有精确匹配所有列的查询才有效

### 5.为什么索引结构默认使用B+Tree，而不是B-Tree，Hash，二叉树，红黑树？

- B-Tree
  - B+Tree的内部节点没有执行关键字的具体信息的指针，内部节点相对B树更小，一次性读入内存的需要查找的关键字也就越多，相对IO读写次数就降低了
  - B+Tree的数据都存储在叶子结点中
- Hash：
  - **没有顺序，io复杂度高**
  - **不支持范围查询**
  - 不支持部分索引列的匹配
  - 。。。
- 二叉树：不能自平衡
- 红黑树：是一颗平衡二叉树，数据量大的时候，树的深度也很深，IO代价高

### <font color=00dd00>6.讲一讲聚簇索引与非聚簇索引？</font>

- 聚簇索引：B+Tree叶子节点存储了整行数据（主键索引）
- 非聚簇索引：B+Tree叶子节点存储了主键的值

### 7.非聚簇索引一定会一定会回表查询吗？

- 如果全部命中索引，就不必在进行回表查询

### 8.联合索引是什么？为什么需要注意联合索引中的顺序？

- 联合索引：使用多个字段建立一个索引
- 注意：需要按照建立索引时的字段**顺序**挨个使用，否则无法命中索引

### <font color=00dd00>9.讲一讲MySQL的最左前缀原则？</font>

- 一定要提供该索引所对应的字段中最左边的字段，也就是排在最前面的字段
- mysql会一直向右匹配，直到遇到范围查询就停止匹配

### 10.讲一讲前缀索引？

- 把很长字段的前面的公共部分作为一个索引
- 注意：order by不支持前缀索引

### 11.了解索引下推吗？（减少回表次数）

- 在不使用ICP（索引下推）的情况下，在使用非主键索引（又叫普通索引或者二级索引）进行查询时，**存储引擎通过索引检索到数据，然后返回给MySQL服务器，服务器然后判断数据是否符合条件。**
- 在使用ICP（索引下推）的情况下，如果存在某些被索引的列的判断条件时，**MySQL服务器将这一部分判断条件传递给存储引擎**，然后由存储引擎通过判断索引是否符合MySQL服务器传递的条件，只有当索引符合条件时才会将数据检索出来返回给MySQL服务器。

索引条件下推优化可以**减少存储引擎查询基础表的次数，也可以减少MySQL服务器从存储引擎接收数据的次数。**

### <font color=00dd00>12.怎么查看MySQL语句有没有使用到索引？</font>

- `explain`

  - `type` ALL 类型因为是全表扫描, 因此在相同的查询条件下, 它是速度最慢的.

     性能由好到差为NULL、system、const、eq_ref、ref、range、 index、all   

    system：查询系统中的表

    const：根据主键查询

    eq_ref：主键索引查询或唯一索引查询

    ref：索引查询

    range：范围查询

    index：索引树扫描

    all：全盘扫描

  - `possible_key`可能用到的索引

  - `key`l当前sql实际命中的索引

  - `key_len `索引占用的大小

  - `rows`估算SQL要查找到结果集需要扫描读取的数据行数，直观显示SQL的效率好坏，原则上越少越好

  - `filtered`满足查询条件的百分比

  - `Extra`额外的优化建议

  | **Extra**                 | **含义**                                                     |
  | ------------------------- | ------------------------------------------------------------ |
  | Using where;  Using Index | 查找使用了索引，需要的数据都在索引列中能找到，不需要回表查询数据 |
  | Using  index condition    | 查找使用了索引，但是需要回表查询数据                         |

> 如果一条sql执行很慢的话，我们通常会使用mysql自动的执行计划explain来去查看这条sql的执行情况，比如在这里面可以通过key和key_len检查是否命中了索引，如果本身已经添加了索引，也可以判断索引是否有失效的情况，第二个，可以通过type字段查看sql是否有进一步的优化空间，是否存在全索引扫描或全盘扫描，第三个可以通过extra建议来判断，是否出现了回表的情况，如果出现了，可以尝试添加索引或修改返回字段来修复

### 13.为什么官方建议使用自增长主键作为索引？

- 减少页分裂和移动的频率。（B+Tree）

### <font color=00dd00>14.如何创建索引？</font>

- `create table`	
- `alter table 表名 add index 索引名(列名)`
- `creat index 索引名 on 表名(列名)`

### <font color=00dd00>15.创建索引时需要注意什么？****</font>

- 非空字段（特殊值代替）
- 取值离散大的字段（唯一性）
- 索引字段越小越好（减少io）

### <font color=00dd00>16.建索引的原则有哪些？</font>

- 最左前缀匹配原则
- =和in可以乱序
- 尽量选择区分度高的（字段不重复的比例）列作为索引
- **索引列不能参与计算**
- 尽量的扩展索引，不要新建索引

### 17.使用索引查询一定能提高查询的性能吗？

索引需要空间来存储，也需要定期维护， 每当有记录在表中增减或索引列被修改时，索引本身也会被修改。 这意味着每条记录的I* NSERT，DELETE，UPDATE将为此多付出4，5 次的磁盘I/O。  因为索引需要额外的存储空间和处理，那些不必要的索引反而会使查询反应时间变慢。

### 18.什么情况下不走索引（索引失效）？

1. `!=`、`<>`
2. **类型不一致**
3. 函数
4. 运算符
5. `OR`
6. **模糊查询**
7. `**not in**`**、**`**not exists**`

## 基础

### 19.数据库的三范式是什么？

...

- 原子性，数据库表的每一列都是不可分割的原子数据项
- 要求实体的属性完成依赖于主关键字
- 任何非主属性不依赖于其他非主属性

### 20.MySQL支持哪些存储引擎?

...

- InnoDB、MyISAM、Memory、Archive。。。
- InnoDB支持外键、事务，是聚簇索引，不支持全文索引，不保存表的具体行数，采用行级锁。

### 21.超键、候选键、主键、外键分别是什么？

...

- 超建：能唯一标识元组的属性集。（候选键+主键）
- 候选键：没有冗余元素的超建
- 主键：对存储数据对象予以唯一和完整标识的数据列或属性的组合
- 外键：在一个表中存在另一个表的主键

### 22.SQL约束有哪几种？

...

- `not null`
- `unique`
- `primary key`
- `foreign key`
- `check`控制字段值范围（oracel）

### 23.MySQL中的varchar和char有什么区别？

...

- char是不可变字段，varchar是可变字段
- 检索效率：char>varchar

### 24.MySQL中in和exists区别

...

- 区别
  1. `in`：把外表和内表作`hash`连接、
  2. `exists`：对外表做`loop`循环，每次循环再对内表查询
- 效率
  - 两个大小相当的表
    - 差别不大
  - 一个较小，一个较大
    - 子查询表大的用`exists`，子查询表小的用`in`
  - 无论那个表大，`not exists`都比`not in`快

### 25.drop、delete与truncate的区别

...				drop		delete		truncate

- **类型		**	DDL			DML		**DDL**
- 回滚			不回滚		回滚			不回滚
- 删除内容		全表,权限,索引	单,多行结构在	全表,结构在
- **删除速度	**	最快			最慢			较快

### 26.什么是存储过程？有哪些优缺点？

...

- 一组为了完成特定功能的SQL语句集，存储在数据库中
- 优点
  - 存储过程可以重复使用，从而减少数据库开发人员的工作量
  - 存储过程位于服务器上，降低了网络传输的数据量
  - 安全性高
- 缺点
  - 开发调试差
  - 可移植性差
  - 如果带有有引用关系的对象发送改变时，受影响的存储过程、包将需要重新编译
  - 维护困难

### 27.MySQL执行查询的过程

...

- 客户端（TCP连接）
- 连接器
- 查缓存
- 分析器（Sql语法）
- 优化器（是否使用索引）
- 执行器（将数据保存到结果集中，同时会逐步将数据缓存到查询缓存中，最终将结果集返回给客户端）

## 事务

### 28.什么是数据库事务？

...

- 从一种一致性状态变到另一种一致性状态
- 事务是逻辑上的一种操作，要么都执行，要么都不执行

### 29.介绍一下事务具有的四个特征

...ACID

- 原子性：要么都做，要么都不做
- **一致性**
- 隔离性：并发执行的各个事务之间不能互相干扰
- 持久性

### 30.说一下MySQL的四种隔离级别

...

- 读未提交		有脏读、不可重复读、幻读问题
- 读已提交		有不可重复读、幻读问题
- 可重复读		默认事务隔离级别，有幻读问题（新增+删除）
- 可串行化

### 31.什么是脏读、幻读、不可重复读？

...

- 脏读是一个事务回滚影响另外一个事务
- 幻读侧重于新增或删除（多了或少了行）
- 不可重复读侧重于修改

### 32.事务的实现原理

...

- 事务是基于重做日志文件（redolog）和回滚日志（undolog）实现的
- 每提交一个事务必须先将该事务的所有日志写入到redolog日志中进行持久化，保证事务的原子性和持久性
- 每当有修改事务时，会产生undolog，如需回滚，根据undolog的方向语句进行逻辑操作，实现数据库的一致性

### 33.MySQL事务日志介绍下？

...

- InnoDB事务日志包括redolog和undolog
- `undolog`指事务开始之前，在操作任何数据之前，首先将需要操作的数据备份到一个地方。
- `redolog`指事务中操作的任何数据，将最新的数据备份到一个地方。
- 事务日志的目的：实例或者介质失败，事务日志文件就能派上用场

### 34.什么是MySQL的binlog？

...

- MySQL的`binlog`是记录所有数据库表结构变更以及表数据修改的二进制日志。`binlog`不会记录`select`和`show`这类操作，因为这类操作对数据本身并没有修改

### 35.在事务中可以混合使用存储引擎吗？

...

- 尽量不要在同一个事务中使用多种存储引擎，MySQL服务器层不管理事务，事务是由下层存储引擎实现的。
- 正常提交的情况是不会有什么问题的，**但如果该事务需要回滚，非事务型的表上的变更就无法撤销，这会导致数据库处于不一致的状态**，这种情况很难修复，事务的最终结果将无法确定，所有选择合适的存储引擎非常重要

### 36.MySQL中是如何实现事务隔离的？

...

- 读未提交、串行化基本上是不需要考虑隔离级别的，前者不加锁限制，后者相当于单线程执行，效率太差
- 可重复读级别解决了幻读问题，通过行锁和间隙锁的组合`Next-key`锁实现的

### 37.什么是MVCC？

...

- 多版本并发控制，是通过保存数据在某个时间点的快照来实现的

### 38.MVCC的实现原理？

...

- `row id`：隐藏的自增ID
- 事务id：记录最后一次修改该记录的事务ID
- 回滚指针：指向这条记录的上一个版本

## 锁

### 39.为什么要加锁？

...

- 保证多用户环境下保证数据库完整性和一致性

### 40.按照锁的粒度分数据库锁有哪些？

...

- 行级锁（`InnoDB`）对当前操作的行加锁
- 表级锁（`MyISAM`）对当前操作的整张表加锁
- 页级锁（`BDB`） 锁定粒度介于行级锁和表级锁中间的一种锁  

### 41.从锁的类别上分MySQL那些锁呢？

...

- 共享锁
- 排他锁（与其他排他锁、共享锁都互斥）

### 42.数据库的乐观锁和悲观锁是什么？怎么实现的？

...

- 悲观锁（多写场景）
  - 假定会发生并发冲突，屏蔽一切可能违反数据完整性的操作。**在查询完数据的时候就把事务锁起来**，直到提交事务。实现方式：使用数据库中的锁机制。
- 乐观锁（多读场景）
  - 假设不会发生并发冲突，只在提交操作时检查是否违反数据完整性。**在修改数据的时候把事务锁起来**，通过version的方式来进行锁定。

### 43.InnoDB引擎的行锁是怎么实现的？

...

- 基于索引来完成行锁

### 44.什么是死锁？怎么解决？

...

- 死锁是指两个或多个事务在同一资源上相互占用，并请求锁定对方的资源，从而导致恶性循环的现象
- 解决方法
  - 尽量约定相同的顺序访问表
  - 尽可能做到一次锁定所需要的所有资源
  - 升级锁定颗粒度

### 45.隔离级别与锁的关系？

...

- `readuncommitted`
- `readcommitted`加共享锁
- `repeatableread`加共享锁
- `Serializable`

### 46.优化锁的方面的意见？

...

- 使用较低的隔离级别
- 设计索引，使用索引去访问数据
- 选择合理的事务大小
- 不同程序访问一张表的时候，尽量约定相同的顺序访问表
- 。。。
  :::info
  分库分表
  :::

### 47.为什么要分库分表？

...	

- 分库：将一个库的数据拆分到多个库中吗，访问的时候就访问一个库好了
  - 并发量特别大的时候，单库可能不足以支撑
- 分表：把一个表的数据放到多个表中，然后查询的时候你就查一个表
  - 在一张表中数据量特别大的时候，数据库的压力也会相对增大，SQL执行的速度也会有一定的影响，为了提高数据库的性能，就要进行分表操作，将一个表的数据放到多个表中，对单个表进行相应的查询，提高整体性能。

### 48.用过哪些分库分表中间件？不同的分库分表中间件都有什么优点？

### 49.如何对数据库进行垂直拆分或水平拆分的？

...

- 垂直拆分
  - 把一个有很多字段的表给拆分成多个表，或者是多个库上去。每个库表的结构都不一样
- 水平拆分
  - 把一个表的数据给弄到多个库的多个表里去，但是每个库的表结构都是一样的
    :::info
    读写分离、中从同步（复制）
    :::

### 50.什么是MySQL主从同步？

...

- 主从同步使得数据可以从一个数据库服务器复制到其他服务器上

### 51.MySQL主从同步的目的？为什么要做主从同步？

...

- 读写分离，提高数据库性能
- 数据备份，提高数据安全

### 52.如何实现MySQL的读写分离？

...

- 主从复制架构（主写从读）

### 53.MySQL主从复制流程和原理？

...

- 主：binlog线程——记录下所有改变了数据库数据的语句，放进master上的`**binlog**`中
- 从：io线程——在使用startslave之后，负责从master上拉取binlog内容，放进自己的**relay****log**中
- 从：SQL执行线程——执行relaylog中的语句

### 54.MySQL主从同步延时问题如何解决？

...

- 半同步复制：解决主库数据库丢失问题
- 并行复制：解决主从同步延时问题
  - 从库开启多个线程，**并行读取relay log 中不同库的日志**，然后并行重放不同库的日志，这是库级别的并行

## 优化

### <font color=00dd00>55.如何定位及优化SQL语句的性能问题(SQL语句执行很慢, 如何分析)</font>

- `explain`

可以采用EXPLAIN 或者 DESC命令获取 MySQL 如何执行 SELECT 语句的信息

```sql
- 直接在select语句之前加上关键字 explain / desc 
EXPLAIN   SELECT   字段列表   FROM   表名   WHERE  条件 ;
```

![image-20230608100903292](https://gitee.com/tjlxy/img/raw/master/image-20230608100903292.png)



### 56.大数据表查询，怎么优化

- 优化shemale、SQL+索引
- 加缓存，redis
- 主从复制、读写分离
- 垂直拆分
- 水平拆分

### 57.超大分页怎么处理?

...

- 缓存

### <font color=00dd00>58.统计过慢查询吗？对慢查询都怎么优化过？</font>

- 分析语句
- 分析语句的执行计划
- 数据量太大，可以分表

### <font color=00dd00>如何定位慢查询?</font>

方案一：开源工具

- 调试工具：Arthas 

- 运维工具：Prometheus 、Skywalking

> 我们当时做压测的时候有的接口非常的慢，接口的响应时间超过了2秒以上，因为我们当时的系统部署了运维的监控系统Skywalking ，在展示的报表中可以看到是哪一个接口比较慢，并且可以分析这个接口哪部分比较慢，这里可以看到SQL的具体的执行时间，所以可以定位是哪个sql出了问题。

方案二：MySQL自带慢查询日志

慢查询日志记录了所有执行时间超过指定参数（long_query_time，单位：秒，默认10秒）的所有SQL语句的日志

如果要开启慢查询日志，需要在MySQL的配置文件（/etc/my.cnf）中配置如下信息：

```shell
# 开启MySQL慢日志查询开关
slow_query_log=1
# 设置慢日志的时间为2秒，SQL语句执行时间超过2秒，就会视为慢查询，记录慢查询日志
long_query_time=2

```

配置完毕之后，通过以下指令重新启动MySQL服务器进行测试，查看慢日志文件中记录的信息 /var/lib/mysql/localhost-slow.log。

![image-20230608100542705](https://gitee.com/tjlxy/img/raw/master/image-20230608100542705.png)

> 如果，项目中没有这种运维的监控系统，其实在MySQL中也提供了慢日志查询的功能，可以在MySQL的系统配置文件中开启这个慢日志的功能，并且也可以设置SQL执行超过多少时间来记录到一个日志文件中，我记得上一个项目配置的是2秒，只要SQL执行的时间超过了2秒就会记录到日志文件中，我们就可以在日志文件找到执行比较慢的SQL了。

### 59.如何优化查询过程中的数据访问

### 60.如何优化关联查询

### 61.数据库结构优化

...

- 将字段很多的表分解成多个表
- 增加中间表
- 增加冗余字段

### 62.MySQL数据库CPU飙升到500%的话他怎么处理？

...

- `top`命令查看占用大的进程
- 判断是否为MySQLd占用导致
  - 不是，找出相关占用高的进程，进行相关处理
  - 是
    - `show processlist`命令查看`session`情况，调整相关SQL语句，重写执行
    - 可能是突然之间有大量的`session`连进来导致CPU飙升，做出相应调整

### 63.大表怎么优化？

...

- 限定数据的范围
- 读/写分离
- **缓存**
- **分库分表**