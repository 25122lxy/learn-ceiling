## RabbitMQ-持久化

### 1. 概念

刚刚我们已经看到了如何处理任务不丢失的情况，但是如何保障当 RabbitMQ 服务停掉以后消息生产者发送过来的消息不丢失。
默认情况下 RabbitMQ 退出或由于某种原因崩溃时，它忽视队列和消息，除非告知它不要这样做。
确保消息不会丢失需要做两件事：我们需要将队列和消息都标记为持久化。

### 2. 队列如何实现持久化

之前我们创建的队列都是非持久化的，rabbitmq 如果重启的化，该队列就会被删除掉，如果要队列实现持久化 需要在声明队列的时候把 durable 参数设置为持久化

在生产者端
```java
        //声明队列
        //【设置队列持久化 】需要让Queue进行持久化
        boolean durable = true;
        channel.queueDeclare(TASK_QUEUE_NAME,durable,false,true,null);
```

但是需要注意的就是如果之前声明的队列不是持久化的，需要把原先队列先删除，或者重新创建一个持久化的队列，不然就会出现错误

队列持久化在控制台也能看到
centos7:15672->Queue->Features:D

这个时候即使重启 rabbitmq 队列也依然存在

### 3. 消息持久化

要想让消息实现持久化需要在消息生产者修改代码，MessageProperties.PERSISTENT_TEXT_PLAIN 添加这个属性。

在生产者端
```java
  //发送消息
            //【设置生产者发送消息为持久化消息（要求保存到磁盘上） 】保存在内存中MessageProperties.PERSISTENT_TEXT_PLAIN
            channel.basicPublish("",TASK_QUEUE_NAME,
                    MessageProperties.PERSISTENT_TEXT_PLAIN,//消息持久化
                    message.getBytes("UTF-8"));
```
